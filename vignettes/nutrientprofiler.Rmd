---
title: "Introduction to nutrientprofiler"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to nutrientprofiler}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The `nutrientprofiler` package aims to provide a series of R functions that 
implement UK Nutrient Profiling Model scoring that can be applied across product 
datasets.

This is broken up into 3 parts within the package: 

- Specific gravity conversions
- Scoring the different nutritional components of the NPM score
- Calculating the NPM score and NPM assessment logic

To start we load the package the with command below.
```{r setup}
library(nutrientprofiler)
```

We can also load some example data to help us with the following examples.
This data was created specifically for this package and so is potentially 
quite different to how your real world data might look.

```{r}
dim(cdrcdrinks)
cdrcdrinks[1, ]
```

## Specific gravity conversions

When trying to determine the NPM score the volume or weight of the product needs
to be adjusted to account for it's specific gravity. 

To adjust product weights or volumes for specific gravity we use the `SGConverter`
function. This is a high level function that is designed to operate on each row of 
a data.frame parsing multiple columns to determine how to calculate the adjusted 
specific gravity score.

```{r}
# using dplyr
library(dplyr)
cdrcdrinks %>%
  rowwise() %>%
  mutate(out = SGConverter(pick(everything()))) %>%
  select(out)

# using base R
cdrcdrinks["sg"] <- unlist(lapply(seq_len(nrow(cdrcdrinks)), function(i) SGConverter(cdrcdrinks[i, ])))
```

The below figure attempts to outline the hierarchy of function calls that `SGConverter` 
initiates. The logic for determining how to adjust values for specific gravity is 
complicated by the potential options around whether a drink is ready-to-drink,
a powdered preparation, or a cordial, within both the powdered and cordial options
additional consideration must be given to the preparation instructions that are provided.
In the below figure each function is named in each node and each column name the function 
uses to dispatch to underlying functions is specified in single quotes. If a function returns
a value it is marked with an empty diamond.

```{r diagram-mermaid, fig.align='center', fig.cap="SGConverter logic", fig.dim=c(10, 6), echo=FALSE}
library(DiagrammeR)
DiagrammeR::mermaid("
graph TB;
  1(SGConverter<br>'product_type') --> 2(sg_food_converter<br>'weight_g');
  1 --> 3(sg_drink_converter<br>'drink_format');
  3 --> 4(sg_ready_drink_converter<br>'drink_type');
  3 --> 5(sg_powd_drink_converter<br>'nutrition_info');
  3 --> 6(sg_cord_drink_converter<br>'nutrition_info');
  6 --> 7{ };
  2 --> 10{ };
  2 --> 11(sg_liquidfood_converter<br>'food_type');
  11 --> 13{ };
  4 --> 14{ };
  5 --> 16{ };
")
```

The `SGConverter` function is specifically developed to calculate specific gravity 
conversions for a data.frame with a number of specificly named columns to help 
organise the dispatch of appropriate functions.

